<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin-layout}">}">
<body>
<div class="flex-1 pt-5 p-8" layout:fragment="content">
    <h1 class="text-3xl font-bold mb-6 text-gray-800" th:text="#{label.manage_posts}">Manage Posts</h1>
    <form method="post" action="/admin/posts/" th:method="post" th:action="@{/admin/posts}">
    <div class="bg-white rounded-lg shadow-md p-6">
        <!-- Action Buttons -->
        <div class="flex justify-between mb-4">
            <div class="flex space-x-2">
                <button id="delete-selected"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md"
                        hx-delete="/admin/posts"
                        hx-on::before-request="checkPostsSelected(event)"
                        hx-swap="none"
                        sec:authorize="hasRole('ROLE_ADMIN')"
                    >
                    <i class="fas fa-trash-alt mr-2"></i> <span th:text="#{label.delete}">Delete</span>
                </button>
                <button id="unpublish-selected" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-md"
                        hx-put="/admin/posts/unpublish"
                        hx-swap="none">
                    <i class="fas fa-eye-slash mr-2"></i> <span th:text="#{label.unpublish}">Unpublish</span>
                </button>
                <button id="archive-selected" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md"
                        hx-put="/admin/posts/archive"
                        hx-swap="none">
                    <i class="fas fa-archive mr-2"></i> <span th:text="#{label.archive}">Archive</span>
                </button>
                <button id="publish-selected" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md"
                        hx-put="/admin/posts/publish"
                        hx-swap="none">
                    <i class="fas fa-eye mr-2"></i> <span th:text="#{label.publish}">Publish</span>
                </button>
            </div>
            <a id="add-post" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md"
                href="/admin/posts/new">
                <i class="fas fa-plus mr-2"></i> <span th:text="#{label.add_post}">Add Post</span>
            </a>
        </div>

        <!-- Posts Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                <tr class="bg-gray-200 text-gray-700">
                    <th class="py-3 px-4 text-left w-12">
                        <input type="checkbox" id="select-all" class="rounded">
                    </th>
                    <th class="py-3 px-4 text-left" th:text="#{label.title}">Title</th>
                    <th class="py-3 px-4 text-left" th:text="#{label.category}">Category</th>
                    <th class="py-3 px-4 text-left" th:text="#{label.status}">Status</th>
                    <th class="py-3 px-4 text-left" th:text="#{label.date}">Date</th>
                    <th class="py-3 px-4 text-left" th:text="#{label.actions}">Actions</th>
                </tr>
                </thead>
                <tbody id="posts-table-body">
                <!-- Posts will be dynamically loaded here -->
                <tr th:each="post : ${posts.data}">
                    <td class="py-3 px-4">
                        <input type="checkbox" name="postIds" class="post-checkbox rounded" th:value="${post.id}">
                    </td>
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-800">
                            <a class="text-blue-600 hover:text-blue-800"
                               th:text="${post.title}"
                               th:href="@{'/posts/'+${post.slug}}">post title</a>
                        </div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs" th:text="${post.category.label}">category name</span>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs"
                              th:classappend="${post.getStatusStyles()}"
                              th:text="${post.status}">status</span>
                    </td>

                    <td class="py-3 px-4" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">post date</td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <a th:href="@{'/admin/posts/' + ${post.id} + '/edit'}" class="text-blue-600 hover:text-blue-800" th:title="#{label.edit}">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="text-red-600 hover:text-red-800" th:title="#{label.delete}"
                                    th:hx-delete="@{'/admin/posts?postIds='+${post.id}}"
                                    hx-confirm="Are you sure you want to delete?"
                                    hx-params="_csrf"
                                    hx-swap="none"
                                    sec:authorize="hasRole('ROLE_ADMIN')">
                                <i class="fas fa-trash-alt"></i>
                            </button>

                            <button class="text-yellow-600 hover:text-yellow-800" th:title="#{label.unpublish}"
                                    th:hx-put="@{'/admin/posts/unpublish?postIds='+${post.id}}"
                                    hx-params="_csrf"
                                    hx-swap="none">
                                <i class="fas fa-eye-slash"></i>
                            </button>

                            <button class="text-gray-600 hover:text-gray-800" th:title="#{label.archive}"
                                    th:hx-put="@{'/admin/posts/archive?postIds='+${post.id}}"
                                    hx-params="_csrf"
                                    hx-swap="none">
                                <i class="fas fa-archive"></i>
                            </button>

                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <th:block th:insert="~{blog/fragments/pagination :: pagination}"></th:block>
    </div>
    </form>
</div>
<th:block layout:fragment="script-content">
<script>
    $(document).ready(function() {
        $("#select-all").change(function() {
            let isChecked = $(this).prop("checked");
            $(".post-checkbox").prop("checked", isChecked);
        });
        
        $(".post-checkbox").change(function() {
            let allChecked = $(".post-checkbox:checked").length === $(".post-checkbox").length;
            $("#select-all").prop("checked", allChecked);
        });
    });
    function checkPostsSelected(event) {
        if ($(".post-checkbox:checked").length === 0) {
            event.preventDefault();
            alert("Select at least one post to delete.");
            return;
        }
        if (confirm('Are you sure you want to proceed?')) {
            event.detail.issueRequest();
        }
    }
</script>
</th:block>
</body>
</html>